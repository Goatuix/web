
local Players = game:GetService("Players")
local RS      = game:GetService("RunService")
local UIS     = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local Camera  = workspace.CurrentCamera
local LP      = Players.LocalPlayer
local mouse   = LP:GetMouse()

getgenv().SA = getgenv().SA or {
  Enabled     = false,
  ShowFov     = false,
  TargetPart  = "HumanoidRootPart",
  FovRadius   = 150,
  Highlight   = false
}
local SA = getgenv().SA


getgenv().fov = getgenv().fov or Drawing.new("Circle")
local fov = getgenv().fov
fov.Thickness, fov.NumSides = 1, 40
fov.Color = Color3.fromRGB(0,255,255)
fov.Transparency = 0.7
fov.Filled = false
fov.Visible = false


local highlights = {} -- [Player] = Highlight
local function ensureHighlightForPlayer(plr)
  if not plr then return end
  local h = highlights[plr]
  if not h then
    h = Instance.new("Highlight")
    h.FillColor = Color3.fromRGB(0,255,255)
    h.FillTransparency = 0.7
    h.OutlineTransparency = 0
    h.Parent = CoreGui
    highlights[plr] = h
  end
  h.Adornee = plr.Character -- update every time
  h.Enabled = true
end

local function clearHighlights(except) 
  for plr, h in pairs(highlights) do
    if not except or not except[plr] then
      h.Enabled = false
      h.Adornee = plr.Character -- keep up-to-date for re-enable
    end
  end
end


Players.PlayerRemoving:Connect(function(plr)
  local h = highlights[plr]
  if h then
    h:Destroy()
    highlights[plr] = nil
  end
end)

-- Render driver: keeps FOV and highlights correct every frame
if getgenv().SA_RENDER then getgenv().SA_RENDER:Disconnect() end
getgenv().SA_RENDER = RS.RenderStepped:Connect(function()
  
  fov.Radius  = SA.FovRadius
  fov.Visible = SA.ShowFov
  local centre
  if UIS.TouchEnabled then
    centre = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
  else
    local ml = UIS:GetMouseLocation()
    centre = Vector2.new(ml.X, ml.Y)
  end
  fov.Position = centre

 
  if SA.Highlight then
    local keep = {}
    for _, p in ipairs(Players:GetPlayers()) do
      if p ~= LP then
        local ch  = p.Character
        local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
        if hrp then
          local vec, onScreen = Camera:WorldToScreenPoint(hrp.Position)
          if onScreen then
            local d = (Vector2.new(vec.X, vec.Y) - centre).Magnitude
            if d <= SA.FovRadius then
              ensureHighlightForPlayer(p)
              keep[p] = true
            end
          end
        end
      end
    end
    clearHighlights(keep)
  else
    clearHighlights(nil)
  end
end)


local mt = getrawmetatable(game)
local originalIndex = mt.__index
local hookFn

local function applyHook()
  local ok = pcall(function()
    setreadonly(mt, false)
    hookFn = newcclosure(function(t, k)
      if SA.Enabled and t == mouse and (k == "Hit" or k == "Target") then
        local centre = fov.Position
        local best, dst = nil, SA.FovRadius

        -- Fresh iteration every call (handles deaths/respawns)
        for _, p in ipairs(Players:GetPlayers()) do
          if p ~= LP then
            local ch   = p.Character
            local hum  = ch and ch:FindFirstChildOfClass("Humanoid")
            local part = ch and ch:FindFirstChild(SA.TargetPart or "HumanoidRootPart")
            if part and hum and hum.Health > 0 and part:IsA("BasePart") then
              local vec, onScreen = Camera:WorldToScreenPoint(part.Position)
              if onScreen then
                local d = (Vector2.new(vec.X, vec.Y) - centre).Magnitude
                if d < dst then best, dst = part, d end
              end
            end
          end
        end

        if best then
          return (k == "Hit") and CFrame.new(best.Position) or best
        end
      end
      return originalIndex(t, k)
    end)
    mt.__index = hookFn
    setreadonly(mt, true)
  end)
  return ok
end

if applyHook() then
  getgenv().SA_HOOK_APPLIED = true
  if getgenv().SA_REHOOK then getgenv().SA_REHOOK:Disconnect() end
  getgenv().SA_REHOOK = RS.RenderStepped:Connect(function()
    if getrawmetatable(game).__index ~= hookFn then
      applyHook()
    end
  end)
end


getgenv().SilentAim = getgenv().SilentAim or {}
local API = getgenv().SilentAim

function API.SetEnabled(v)   SA.Enabled = not not v end
function API.SetShowFov(v)   SA.ShowFov = not not v; fov.Visible = SA.ShowFov end
function API.SetHighlight(v) SA.Highlight = not not v; if not SA.Highlight then clearHighlights(nil) end end
function API.SetTargetPart(p) if p == "Head" or p == "HumanoidRootPart" then SA.TargetPart = p end end
function API.SetFovRadius(r) local n = tonumber(r); if n then SA.FovRadius = math.clamp(math.floor(n + 0.5), 10, 1000) end end
